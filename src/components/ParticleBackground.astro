---
import Particles from "astro-particles"
import type { ISourceOptions } from "tsparticles-engine";

let options: ISourceOptions = {
    background: {
      color: "#000000", // deep space black
      opacity: 0.5,
    },
    fullScreen: { zIndex: -1 },
    particles: {
      number: { value: 90, density: { enable: true, area: 1000 } },
      color: { value: "#ffffff" },
      shape: { type: "circle" },
      opacity: { value: 0.8, random: true },
      size: { value: 2, random: true },
      links: {
        enable: true,
        distance: 160,
        color: { value: "#8888ff" },
        opacity: 0.3,
        width: 1,
      },
      move: {
        enable: true,
        speed: 0.8,
        direction: "none",
        random: true,
        straight: false,
        outModes: { default: "bounce" },
        attract: { distance: 90, enable: true, rotateX: 100, rotateY: 900 },
      },
    },
    interactivity: {
      events: {
        onHover: { enable: true, mode: "grab" },
        onClick: { enable: true, mode: "repulse" },
      },
      modes: {
        grab: { distance: 150, links: { opacity: 0.5, color: { value: "#8888ff" } } },
        repulse: { distance: 75, duration: 0.4 },
      },
    },
    retina_detect: true,
  };


---

<script>
    

    import { type Container, type Engine } from "tsparticles-engine";
    import { loadFull } from "tsparticles";

    // the function name is the parameter passed to the init attribute
    // required
    window.particlesInit = async function (engine: Engine) {
        await loadFull(engine);
        
    }
    
    // the function name is the parameter passed to the loaded attribute
    // optional
    window.particlesLoaded = function (container: Container) {
        console.log("particlesLoaded callback");
    

    }

    // read themes from css for dynamc switching
    // function getThemeVars(varNames: string[]) {
    //     const sheets = Array.from(document.styleSheets) as CSSStyleSheet[];
    //     const result: Record<string, { light?: string; dark?: string }> = {};

    //     varNames.forEach((varName) => {
    //         result[varName] = { light: undefined, dark: undefined };

    //   sheets.forEach((sheet) => {
    //     try {
    //       Array.from(sheet.cssRules).forEach((rule: CSSRule) => {
    //         if (!(rule instanceof CSSStyleRule)) return;

    //         if (rule.selectorText === ":root") {
    //           const val = rule.style.getPropertyValue(varName).trim();
    //           if (val) result[varName].light = val;
    //         } else if (rule.selectorText === ".dark") {
    //           const val = rule.style.getPropertyValue(varName).trim();
    //           if (val) result[varName].dark = val;
    //         }
    //       });
    //     } catch (e) {
    //       // ignore cross-origin stylesheets
    //     }
    //   });
    // });

    // return result;
    // }

    function getThemeVars(varNames) {
      const root = document.documentElement;
      const darkProbe = document.createElement('div');
      darkProbe.classList.add('dark');
      document.body.appendChild(darkProbe);

      let result = {};

      varNames.forEach((name) => {
        // read computed styles
        const lightVal = getComputedStyle(root).getPropertyValue(name).trim();
        const darkVal = getComputedStyle(darkProbe).getPropertyValue(name).trim();
        result[name] = { light: lightVal, dark: darkVal };
      });

      document.body.removeChild(darkProbe);
      return result;
    }


  const themes = getThemeVars([
    "--color-particle-background",
    "--color-particles",
    "--color-links",
  ]);

  // Set initial particle background settings based on current theme
  document.addEventListener("DOMContentLoaded", () => {
    // Wait a short tick to ensure tsParticles has initialized
    setTimeout(() => {
      const container = window.tsParticles?.domItem(0);
      if (!container) return;

            // Check if initial is dark or light
            const html = document.documentElement; // Get html element
            const isDark = !html.classList.contains("dark");

            // Get update colours based on css settings (use themes dictionary object)
            container.options.background.color.value = isDark ? themes["--color-particle-background"].light : themes["--color-particle-background"].dark;
            container.options.particles.color.value = isDark ? themes["--color-particles"].light : themes["--color-particles"].dark;
            container.options.particles.links.color.value = isDark ? themes["--color-links"].light : themes["--color-links"].dark;
            container.options.particles.move.speed = isDark ? 2.1 : 0.6;
            
            container.refresh();
            
        }, 50); // 50ms delay to be safe
    });
    
    // Update particle background color on theme toggle
    const button = document.getElementById("theme-toggle");
    button?.addEventListener("click", () => {
        const html = document.documentElement; // Get html element
        const overlay = document.getElementById("particle-overlay"); // Get particle overlay div
        const container = window.tsParticles?.domItem(0); // Get tsParticles container
        if (!container || !overlay) return;

        // Use pre-read colours to load
        const wasDark = !html.classList.contains("dark");
        const oldColor = wasDark ? themes["--color-particle-background"].dark : themes["--color-particle-background"].light;
        const newColor = wasDark ? themes["--color-particle-background"].light : themes["--color-particle-background"].dark;

    // cover the screen with the old color immediately
    overlay.style.transition = "none";
    overlay.style.backgroundColor = oldColor;
    overlay.style.opacity = "0.8";
    overlay.getBoundingClientRect(); // force style repaint

    // Update particle settings and refresh (instant switch)
    container.options.background.color.value = wasDark ? themes["--color-particle-background"].light : themes["--color-particle-background"].dark;
    container.options.particles.color.value = wasDark ? themes["--color-particles"].light : themes["--color-particles"].dark;
    container.options.particles.links.color.value = wasDark ? themes["--color-links"].light : themes["--color-links"].dark;
    container.options.particles.move.speed = wasDark ? 2.1 : 0.6;
    container.refresh();

        // Fade the overly div from old colour and opaque to new colour and transparent
        requestAnimationFrame(() => {
            overlay.style.transition = "background-color 0.4s ease, opacity 0.4s ease";
            overlay.style.backgroundColor = newColor;
            overlay.style.opacity = "0";
        });


    });

  
</script>

<div id="particle-wrapper">
    <div id="particle-gradient"></div>
    </div><Particles id="tsparticles" options={options} init="particlesInit" />
    <div id="particle-overlay"></div>
</div>